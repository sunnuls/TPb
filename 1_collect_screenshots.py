#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
–®–ê–ì 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
"""
import os
import sys
import time
from datetime import datetime
from PIL import ImageGrab
import keyboard

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É –¥–ª—è Windows
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

print("=" * 70)
print("–°–ë–û–† –°–ö–†–ò–ù–®–û–¢–û–í –î–õ–Ø –û–ë–£–ß–ï–ù–ò–Ø –ú–û–î–ï–õ–ò")
print("=" * 70)

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
output_dir = "training_data/raw_screenshots"
os.makedirs(output_dir, exist_ok=True)

print(f"\n–°–∫—Ä–∏–Ω—à–æ—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {output_dir}")
print("\n" + "=" * 70)
print("–ò–ù–°–¢–†–£–ö–¶–ò–Ø:")
print("=" * 70)
print("""
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–∫–µ—Ä-—Ä—É–º (PokerStars, 888poker, etc.)
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç–æ–ª —Å –∫–∞—Ä—Ç–∞–º–∏
3. –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã:
   
   –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò: –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
   –í–†–£–ß–ù–£–Æ: –Ω–∞–∂–º–∏—Ç–µ F8 –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
   –û–°–¢–ê–ù–û–í–ö–ê: –Ω–∞–∂–º–∏—Ç–µ ESC –¥–ª—è –≤—ã—Ö–æ–¥–∞

4. –ò–≥—Ä–∞–π—Ç–µ –∏–ª–∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –∏–≥—Ä–æ–π
5. –°–æ–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 200 —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ (–ª—É—á—à–µ 500-1000)

–í–ê–ñ–ù–û: –°–æ–±–∏—Ä–∞–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏:
  - –ü—Ä–µ—Ñ–ª–æ–ø, —Ñ–ª–æ–ø, —Ç–µ—Ä–Ω, —Ä–∏–≤–µ—Ä
  - –†–∞–∑–Ω—ã–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ
  - –í–∞—à–∏ –∫–∞—Ä—Ç—ã + –∫–∞—Ä—Ç—ã –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–≤
  - –†–∞–∑–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è
""")

print("\n" + "=" * 70)

# –°—á–µ—Ç—á–∏–∫–∏
auto_count = 0
manual_count = 0
total_count = 0

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
def take_screenshot(prefix="auto"):
    global auto_count, manual_count, total_count
    
    try:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S_%f")[:-3]
        filename = f"{prefix}_{timestamp}.png"
        filepath = os.path.join(output_dir, filename)
        
        screenshot = ImageGrab.grab()
        screenshot.save(filepath)
        
        if prefix == "auto":
            auto_count += 1
        else:
            manual_count += 1
        
        total_count += 1
        
        print(f"[{total_count}] –°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {filename}")
        print(f"    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö: {auto_count} | –†—É—á–Ω—ã—Ö: {manual_count}")
        
        return True
    except Exception as e:
        print(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: {e}")
        return False

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ F8 –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
def on_f8():
    print("\n[F8] –°–æ–∑–¥–∞—é —Å–∫—Ä–∏–Ω—à–æ—Ç –≤—Ä—É—á–Ω—É—é...")
    take_screenshot("manual")

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É
keyboard.add_hotkey('f8', on_f8)

print("\nüöÄ –ù–ê–ß–ò–ù–ê–ï–ú –°–ë–û–† –°–ö–†–ò–ù–®–û–¢–û–í!")
print("–ù–∞–∂–º–∏—Ç–µ ESC –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\n")
print("=" * 70)

# –î–∞–µ–º –≤—Ä–µ–º—è –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è
for i in range(5, 0, -1):
    print(f"–ù–∞—á–∞–ª–æ —á–µ—Ä–µ–∑ {i} —Å–µ–∫...")
    time.sleep(1)

print("\n‚úÖ –°–ë–û–† –ù–ê–ß–ê–õ–°–Ø!")
print("=" * 70 + "\n")

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
try:
    last_auto_time = time.time()
    auto_interval = 10  # —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏
    
    while True:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º ESC
        if keyboard.is_pressed('esc'):
            print("\n[ESC] –û—Å—Ç–∞–Ω–æ–≤–∫–∞...")
            break
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
        current_time = time.time()
        if current_time - last_auto_time >= auto_interval:
            take_screenshot("auto")
            last_auto_time = current_time
        
        time.sleep(0.1)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

except KeyboardInterrupt:
    print("\n[CTRL+C] –û—Å—Ç–∞–Ω–æ–≤–∫–∞...")

finally:
    print("\n" + "=" * 70)
    print("–°–ë–û–† –ó–ê–í–ï–†–®–ï–ù!")
    print("=" * 70)
    print(f"\n–í—Å–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤: {total_count}")
    print(f"  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö: {auto_count}")
    print(f"  - –†—É—á–Ω—ã—Ö (F8): {manual_count}")
    print(f"\n–ü–∞–ø–∫–∞: {output_dir}")
    print("\n" + "=" * 70)
    print("–°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì:")
    print("=" * 70)
    print("""
1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://roboflow.com
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç: "Online Poker Cards"
4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∏–∑ –ø–∞–ø–∫–∏: training_data/raw_screenshots/
5. –†–∞–∑–º–µ—Ç—å—Ç–µ –∫–∞—Ä—Ç—ã (–ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ 2_annotate_guide.txt)
6. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞—Ç–∞—Å–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ YOLOv8
7. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ: python 3_train_model.py
""")
    print("\nüí° –†–µ–∫–æ–º–µ–Ω–¥—É—é —Å–æ–±—Ä–∞—Ç—å –º–∏–Ω–∏–º—É–º 200 —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤")
    print("   –ß–µ–º –±–æ–ª—å—à–µ - —Ç–µ–º –ª—É—á—à–µ –±—É–¥–µ—Ç –º–æ–¥–µ–ª—å!")
