#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""–û–±—É—á–µ–Ω–∏–µ YOLOv8 –Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç–µ –∏–≥—Ä–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç"""
import os
import sys

print("=" * 70)
print("üé¥ –û–ë–£–ß–ï–ù–ò–ï AI –ú–û–î–ï–õ–ò –ù–ê –¢–í–û–Å–ú –î–ê–¢–ê–°–ï–¢–ï")
print("=" * 70)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º ultralytics
try:
    from ultralytics import YOLO
    print("‚úÖ Ultralytics —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
except ImportError:
    print("\n‚ùå Ultralytics –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    print("üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...")
    os.system("pip install ultralytics -q")
    try:
        from ultralytics import YOLO
        print("‚úÖ Ultralytics —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
    except:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Ultralytics")
        print("\n–£—Å—Ç–∞–Ω–æ–≤–∏ –≤—Ä—É—á–Ω—É—é: pip install ultralytics")
        sys.exit(1)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç–∞—Å–µ—Ç
dataset_path = "Playing Cards.v4-fastmodel-resized640-aug3x.yolov8"
data_yaml = os.path.join(dataset_path, "data.yaml")

if not os.path.exists(data_yaml):
    print(f"\n‚ùå –î–∞—Ç–∞—Å–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {dataset_path}")
    print("\nüìã –ß—Ç–æ –¥–µ–ª–∞—Ç—å:")
    print("1. –°–∫–∞—á–∞–π –¥–∞—Ç–∞—Å–µ—Ç —Å Roboflow")
    print("2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å (–Ω–∞–∂–º–∏ –¢–ï–°–¢ –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø)")
    sys.exit(1)

print(f"‚úÖ –î–∞—Ç–∞—Å–µ—Ç –Ω–∞–π–¥–µ–Ω: {dataset_path}")
print(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: {data_yaml}")

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
os.makedirs('weights', exist_ok=True)

print("\n" + "=" * 70)
print("üöÄ –ù–ê–ß–ò–ù–ê–Æ –û–ë–£–ß–ï–ù–ò–ï...")
print("=" * 70)
print("\n‚è±Ô∏è  –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:")
print("   - –ù–∞ GPU (NVIDIA): 10-30 –º–∏–Ω—É—Ç")
print("   - –ù–∞ CPU: 1-3 —á–∞—Å–∞")
print("\nüìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è:")
print("   - –ú–æ–¥–µ–ª—å: YOLOv8s (small)")
print("   - –≠–ø–æ—Ö: 50")
print("   - –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 640x640")
print("   - Batch size: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
print("\n" + "-" * 70)
print("‚ùó –ù–ï –ó–ê–ö–†–´–í–ê–ô –≠–¢–û –û–ö–ù–û!")
print("-" * 70 + "\n")

try:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å
    print("üì• –ó–∞–≥—Ä—É–∂–∞—é –±–∞–∑–æ–≤—É—é YOLOv8s...")
    model = YOLO('yolov8s.pt')
    
    # –û–±—É—á–∞–µ–º
    print("üéØ –ù–∞—á–∏–Ω–∞—é –æ–±—É—á–µ–Ω–∏–µ...\n")
    results = model.train(
        data=data_yaml,
        epochs=50,          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö
        imgsz=640,          # –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        patience=10,        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π
        save=True,          # –°–æ—Ö—Ä–∞–Ω—è—Ç—å —á–µ–∫–ø–æ–∏–Ω—Ç—ã
        plots=True,         # –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏
        verbose=True,       # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
        device='cpu'        # –ò—Å–ø–æ–ª—å–∑—É–µ–º CPU (–∑–∞–º–µ–Ω–∏ –Ω–∞ 0 –¥–ª—è GPU)
    )
    
    # –ö–æ–ø–∏—Ä—É–µ–º –ª—É—á—à—É—é –º–æ–¥–µ–ª—å
    best_model_path = "runs/detect/train/weights/best.pt"
    if os.path.exists(best_model_path):
        import shutil
        target_path = "weights/best.pt"
        shutil.copy2(best_model_path, target_path)
        
        file_size = os.path.getsize(target_path) / 1024 / 1024
        
        print("\n" + "=" * 70)
        print("üéâ –û–ë–£–ß–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!")
        print("=" * 70)
        print(f"\n‚úÖ –ú–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {target_path}")
        print(f"üìä –†–∞–∑–º–µ—Ä: {file_size:.1f} MB")
        print("\nüìã –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:")
        print("1. –ó–∞–∫—Ä–æ–π GUI (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç)")
        print("2. –ó–∞–ø—É—Å—Ç–∏: RUN_GUI.bat")
        print("3. –í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ —Å—Ç–æ–ª–∞")
        print("4. –ù–∞–∂–º–∏: –¢–ï–°–¢ –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø")
        print("\nüöÄ –ì–û–¢–û–í–û –ö –†–ê–ë–û–¢–ï!")
        print("=" * 70)
    else:
        print("\n‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è!")
        print(f"–û–∂–∏–¥–∞–ª–æ—Å—å: {best_model_path}")
        
except KeyboardInterrupt:
    print("\n\n‚ö†Ô∏è  –û–±—É—á–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!")
    print("–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
    
except Exception as e:
    print(f"\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏: {e}")
    print("\nüìã –ß—Ç–æ –¥–µ–ª–∞—Ç—å:")
    print("1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –¥–∞—Ç–∞—Å–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π")
    print("2. –ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å")
    print("3. –ò–ª–∏ —Å–∫–∞—á–∞–π –≥–æ—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å (—Å–º. –†–ê–ë–û–ß–ò–ï_–°–°–´–õ–ö–ò_–°–ö–ê–ß–ê–¢–¨.md)")

print("\n" + "=" * 70)
input("–ù–∞–∂–º–∏ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
